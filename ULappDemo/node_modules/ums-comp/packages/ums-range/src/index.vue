<template>
    <div class="range" :class="[disabled?'disabled':'']" ref="range">
        <slot name="start"></slot>
        <div class="content" ref="content">
            <div class="track" :style="[trackStyles]" >
                <div class="inner" :style="{width}"></div>
            </div>
            <div class="cButton" :style="{transform:distance}" @panstart="start" @panmove="move($event)"></div>
        </div>
        <slot name="end"></slot>
    </div>
</template>

<script>
    export default{
        data(){
            return {
                offset: '',
                distance: 'translateX(0px)',
                width: 0,
                trackLength: 300,
                startPos: 0,
                stepRate: 0 //按照比例计算，每次移动的长度
            }
        },
        props: {
            //最大值
            max: {
                type:Number,
                default: 100
            },
            //最小值
            min: {
                type:Number,
                default: 0
            },
            //禁用状态
            disabled: {
                type: Boolean,
                default: false
            },
            //初始值
            initial: {
                type: [Number,String],
                default: 0
            },
            //轨道的高度
            barHeight: {
                type: [Number,String],
                default: '4px'
            },
            //轨道的长度
            length:{
                type:[Number,String],
                default: '300px'
            },
            step: {
                type: Number,
                default: 1
            }
        },
        computed:{
            trackStyles(){
                let styles = {};
                styles.height = this.unitParse(this.barHeight);
                styles.width = this.unitParse(this.length);
                this.trackLength = parseInt(this.length);
                return styles;
            }
        },
        mounted(){
            this.initalRate(this.initial);
            this.stepRate = Math.round(this.step/(this.max - this.min)* this.trackLength);
        },
        methods: {
            unitParse(val){
                if (val == undefined){
                    return ;
                }
                if (typeof val == 'number'){
                    val+= 'px'
                }else{
                    if (isNaN(parseInt(val))){
                        throw new Error(`bad parameter: ${val}`)
                    }
                    if (val.indexOf('px') == -1){
                        val+='px'
                    }
                }
                return val;
            },
            _DragMove(option){
                let distTemp,dist;
                dist = option.x - this.offset;
                if (this.step != 1){
                    distTemp = option.x - this.startPos;
                    if (Math.abs(distTemp) < this.stepRate){
                        return ;
                    }else {
                        distTemp < 0 ? this.startPos-= this.stepRate : this.startPos+= this.stepRate;
                        dist = Math.round(dist/this.stepRate) * this.stepRate;
                    }
                }
                if (dist >　this.trackLength || dist < 0){
                    if (dist < 0){
                        dist = 0
                    }else{
                        dist = this.trackLength
                    }
                }
                this.calRate(dist);
                this.width = dist+'px'
                this.distance = `translateX(${dist}px)`
            },
            _DragStart(option){
                if (this.offset == ''){
                    this.offset = option.x
                }
                this.startPos = option.x
            },
            start(event){
                this._DragStart({x:event.changedTouches[0].screenX});
            },
            move(event){
                if (this.disabled){
                    return ;
                }
                this._DragMove({x:event.changedTouches[0].screenX});
            },
            calRate(val){
                let rate = this.calDist(val);
                this.$emit('rangeChange',rate);
            },
            initalRate(val){
                let dist = this.calDist(val);
                this.width = dist;
                this.distance = `translateX(${dist}px)`;
            },
            calDist(val){
                return Math.round((this.max-this.min)/this.trackLength*val+parseInt(this.min));
            }
        }
    }
</script>

<style lang='stylus' rel="stylesheet/stylus" scoped>
    @import '../../../src/styles/var'
    btn-width = 60
    .range
        flex-direction row
        align-items center
        height: (btn-width)px
    .content
        flex-direction: row
        padding: 5px
        align-items: center
        height: (btn-width)px
        padding-left (btn-width/2)px
        padding-right: @padding-left
    .cButton
        border-color: $border-color
        border-width: 1px
        width: (btn-width)px
        height: @width
        border-radius: (btn-width/2)px
        background-color: $range-button-background-color
        position absolute
        left: 0px
        top: 0px
    .track
        background-color: $track-background-color
        overflow hidden
        flex-direction row
        justify-content flex-start
    .inner
        height: 300px
        background-color $info-color
    .disabled
        opacity 0.6
</style>