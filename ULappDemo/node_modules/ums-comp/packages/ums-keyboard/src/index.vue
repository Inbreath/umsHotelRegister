<template>
    <div style="flex-direction: row;align-items: flex-end" class="fixedBottom">
        <div class="board" ref="board" :style="alphaNumberChange">
            <div  v-for="key in numberListLayout" class="kb"
                  :class="key.className" @click="key.click($event,key.val)">
                <text class="txt" :style="[key.styles]">{{key.val}}</text>
            </div>
        </div>
        <div class="alpha-board" v-if="type =='alpha'">
            <div v-for="rows in alphaListLayot" class="alpha-row">
                <div v-for="key in rows"  class="alpha-kb"
                     :class="key.className" @click="key.click($event,key.val)">
                    <text class="alpha-text" :style="[key.styles !== undefined && key.styles]">{{key.val|alphaChar(alphaShift)}}</text>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    const he = require('he');
    const ums_api = require('ums-api')
    var modal = weex.requireModule('modal');
    export default{
        data(){
            return {
                value:'',
                alphaShift:false,                                                   // 英语键盘，上档键是否开启
                alphaFlag:false,                                                    // 英语键盘，是否开启
                alphaList:[                                                         // 英语键盘的格式
                    ['q','w','e','r','t','y','u','i','o','p'],
                    ['a','s','d','f','g','h','j','k','l'],
                    ['z','x','c','v','b','n','m'],
                ]
            }
        },
        watch:{
            value(newVal){                                                          // 点击按键的时候触发
                this.$emit('keyboardInput',newVal);
            },
            type(newVal){                                                           // 定义初始的格式
                if(this.alphaFlag){
                    this.alphaFlag =false;
                }
                if(newVal ==='number' || newVal === 'alpha'){
                    this.value = ''
                }else if(newVal === 'amount'){
                    this.value = "￥0.00";
                    this.$emit('keyboardInput',this.value);
                }
            },
        },
        props:{
            isRandom:{                                                              // 键盘的数字时候随机
                type:Boolean,
                default:false
            },
            disabledKeys:{                                                          // 禁用的键
                type:Array
            },
            prefix:{                                                                // 前缀
                type:String
            },
            suffix:{                                                                // 后缀
                type:String
            },
            type:{                                                                  // 键盘的样式
                type:String,
                default:"alpha"                                                     // 键盘的样式: alpha、amount、number
            },
            limit:{                                                                 // 限制输入的位数
                type:Number,
                default:11
            }
        },
        filters:{
            alphaChar(val,upperCase){                                               // 大小写格式化
                if(upperCase){
                    return val.toUpperCase();
                }else{
                    return val.toLowerCase();
                }
            }
        },
        computed:{
            alphaNumberChange(){                                                    // 数字键盘和英语键盘切换的样式
                let styles={};
                if(this.alphaFlag){
                    styles.marginLeft='-750px';
                    styles.opacity = 0;
                }else{
                    styles.marginLeft='0px';
                    styles.opacity = 1;
                }
                return styles;
            },
            numberList() {                                                          // 数字键盘的内容
                let list = ['1', '2', '3', '4', '5', '6', '7', '8', '9','0'];
                if (this.type === 'number' && this.isRandom) {
                    list = list.sort(function(a, b) {
                        return Math.random() > 0.5 ? -1 : 1;
                    });
                }
                return list
            },
            numberListLayout(){                                                     // 数字键盘的布局
                let list = this.numberList;
                let layout = [];
                let colBtn =  this.type === 'number'? this.nextBtn: this.confirmBtn;
                let specBtn = [this.delBtn(), this.clearBtn(), colBtn(), this.emptyBtn(), this.dotBtn()];
                for(let i=0,j=0;i<list.length;i++){
                    if(i != 0 && i%3 ==0 && j<specBtn.length){
                        layout.push(specBtn[j++]);
                    }
                    if(i == 9){
                        if(this.type === 'amount'){
                            layout.push({
                                val:list[i],
                                className:['rowspan-4','enable','number'],
                                click:this.valubtnClick
                            })
                            continue;
                        }else if(this.type === 'number'){
                            layout.push(specBtn[j++]);
                            layout.push({
                                val:list[i],
                                className:['colspan-4','enable','number'],
                                click:this.valubtnClick
                            })
                            continue;
                        }else if(this.type === 'alpha'){
                            layout.push(this.alphaBtn());
                            layout.push({
                                val:list[i],
                                className:['alpha-4','enable','alpha'],
                                click:this.valubtnClick
                            })
                            layout.push(specBtn[j++]);
                            continue;
                        }
                    }
                    layout.push(Object.assign({val:list[i]},{className:['enable',this.type ==='alpha'?'alpha':'number'],click:this.valubtnClick}));
                }
                if(this.type === "number"){
                    layout.push(specBtn[specBtn.length-1]);
                }
                return layout;
            },
            alphaListLayot(){                                                       // 英语键盘的布局
                let list = this.alphaList;
                let layout = [],tmp;
                let specBtn = [this.numberBtn(), this.spaceBtn(), this.confirmBtn(), this.clearBtn(true)];
                specBtn[0].className.push('alpha-kb-flex1');
                specBtn[1].className.push('alpha-kb-flex2');
                specBtn[2].className.push('alpha-kb-flex2');
                specBtn[2].className.shift();
                specBtn[3].className.push('alpha-kb-flex1');
                for(let i=0; i< list.length;i++){
                    tmp = [];
                    for(let j=0; j<list[i].length;j++){
                        tmp.push({
                            val:list[i][j],
                            className:[],
                            click:this.valubtnClick
                        })
                    }
                    if(i ==2){
                        tmp.unshift(this.shiftBtn());
                        tmp.push(this.delBtn(true));
                    }
                    layout.push(tmp);
                }
                layout.push(specBtn);
                return layout;
            }
        },
        beforeCreate(){
            var dom = weex.requireModule('dom');
            dom.addRule('fontFace',{
                fontFamily:'iconfont',
                src:"url('../../../static/font/UmsIconFont.ttf')"
            })
        },
        methods:{
            dotclick(event){                                                            // 逗号键的点击事件
                if(this.value.indexOf(".")>0){
                    return;
                }
                if(this.value == ''){
                    this.value = "0."
                }else{
                    this.value+='.'
                }
            },
            shiftClick(){                                                               // 上档键的点击事件
                this.alphaShift = !this.alphaShift;
            },
            clearClick(event){                                                          // 清除键的点击事件
                if(this.type == 'amount'){
                    this.value = "￥0.00";
                }else{
                    this.value = "";
                }
            },
            delClick(event){                                                            // 删除键的点击事件
                if(this.type === 'number' || this.type === 'alpha'){
                    this.value = this.value.slice(0,-1);
                }else if(this.type === 'amount'){
                    this.value = this.value.slice(1);
                    if(this.value == 0.01 || this.value == '0.00'){
                        this.value = "￥0.00";
                        return;
                    }
                    let tmp = Math.floor(this.value*10)/100;
                    if(tmp == 0){
                        this.value = '￥0.00'
                    }else{
                        this.value = `￥${tmp}`;
                    }
                }
            },
            nextClick(event){                                                           // ‘下一步’键的点击事件
                if (this.value==='' || this.value === '￥0.00') {
                    return
                }
                this.$emit('onClickNextButton');
            },
            valubtnClick(event,val){                                                    // 普通键的点击事件
                if (this.value.length >= this.limit){
                    return ;
                }
                if(this.type === 'number') {
                    this.value += val;
                }else if(this.type === 'amount'){
                    this.value = (this.value.slice(1))*10+ val*0.01;
                    this.value = "￥"+this.value.toFixed(2);
                }else if(this.type === 'alpha'){
                    if(this.alphaFlag){
                        if(val<65){
                            return;
                        }
                    }
                    if(this.alphaShift){
                        val = val.toUpperCase();
                    }
                    this.value +=val;
                }
            },
            confirmClick(event){                                                         // 确定键的点击事件
                if (this.value==='' || this.value === '￥0.00') {
                    return
                }
                this.$emit('onConfirmClick');
            },
            alphaClick(event){                                                           // 英 -> 数 键切换为英语键盘的点击事件
                this.alphaFlag = true;
            },
            numberClick(){                                                               // 英 -> 数 键切换为数字键盘的点击事件
                this.alphaFlag = false;
            },
            spaceClick(event){                                                           // 空格事件的点击事件
                this.value= this.value+" ";
            },
            delBtn(alphaFlag = false){                                                   // 删除键的样式
                return {
                    val:he.decode("&#xe60e;"),
                    className:['enable', alphaFlag ? 'alpha-kb' : this.type],
                    styles:{
                        'font-family':'iconfont'
                    },
                    click:this.delClick
                }
            },
            clearBtn(alphaFlag = false){                                                 // 清除键的样式
                return {
                    val:"清除",
                    className:['enable', alphaFlag ? '' : this.type],
                    click:this.clearClick
                }
            },
            nextBtn(){                                                                   // 下一步 键的样式
                return {
                    val:"下一步",
                    className:['colspan',(this.value === '' || this.value === '￥0.00') ? 'nextBtn-disable' : 'nextBtn-enable'],
                    styles:{
                        'color':'#fff'
                    },
                    click:this.nextClick
                }
            },
            confirmBtn(){                                                                // 确定键的样式
                return {
                    val:"确定",
                    className:[this.type ==='alpha'?'colspan-alpha':'colspan',(this.value==='' || this.value === '￥0.00') ?'nextBtn-disable':'nextBtn-enable'],
                    styles:{
                        'color':'#fff'
                    },
                    click:this.confirmClick
                }
            },
            shiftBtn(alphaFlag = false){                                                 // 上档键的样式
                return {
                    val: he.decode('&#xe65a;'),
                    className:['enable', alphaFlag ? 'alpha-kb-flex1' : ''],
                    styles:{
                        'font-family':'iconfont'
                    },
                    click:this.shiftClick
                }
            },
            emptyBtn(){                                                                  // 空格键的样式
                return {
                    val:" ",
                    className:this.type ==='alpha'?['alpha-4','alpha']:['colspan-4','number']
                }
            },
            dotBtn(){                                                                    // 逗号键的样式
                return{
                    val:".",
                    className:['colspan-4','enable'],
                    click:this.dotclick
                }
            },
            alphaBtn(){                                                                  // 数->英键的样式
                return {
                    val: "ABC",
                    className:['alpha-4','enable',`${this.type}`],
                    click:this.alphaClick
                }
            },
            numberBtn(){                                                                 // 英->数键的样式
                this.alphaFlag ==true;
                return{
                    val: "123",
                    className:['enable'],
                    click:this.numberClick
                }
            },
            spaceBtn(){                                                                  // 空格键的样式
                return {
                    val: "空格",
                    className:['enable'],
                    click:this.spaceClick
                }
            }
        }
    }
</script>

<style lang='stylus' rel="stylesheet/stylus" scoped>
    @import '../../../src/styles/var'
    .fixedBottom
        position: fixed
        bottom: 0px
        left: 0px
    .board
        flex-direction: row
        flex-wrap: wrap
        width: 750px
        border-top-width: 1px
        border-color: $keyboard-key-color
        background-color: #fff
    .alpha-board
        width 750px
        padding-bottom: 10px
        border-top-width: 1px
        border-color: $keyboard-key-color
        flex-direction: column
        background-color: #fff
    .kb
        width:187px
        height: 186px
        justify-content center
        align-items: center
        border-left-width 1px
        border-bottom-width 1px
        border-color: $keyboard-key-color
        margin-right -1px
        margin-bottom -1px
    .alpha
        height 134px
    .alpha-row
        flex-direction: row
        justify-content: center
        border-bottom-width: 0px
    .alpha-kb
        width: 56px
        height: 102px
        margin-top: 24px
        margin-buttom: 24px
        margin-left: 8px
        margin-right: 8px
        border-width: 1px
        border-color: $keyboard-key-color
        justify-content: center
        align-items: center
        border-radius: 10px
    .alpha-kb:active
        background-color $keyboard-key-color
    .number
        height: 186px
    .enable:active
        background-color: $keyboard-key-color
    .txt
        text-align: center
        font-size: 72px
    .alpha-text
        text-align: center
        font-size: 40px
    .rowspan-4
        width: 558px
        margin-top: -186px
    .colspan
        width 191px
        height: 372px
        padding-left: 36px
        padding-right: 36px
        background-color: $keyboard-key-color
    .colspan-alpha
        width 191px
        height: 268px
    .alpha-4
        margin-top: -134px
    .colspan-4
        margin-top: -186px
    .nextBtn-enable
        background-color: $keyboard-next-button-color
    .nextBtn-enable:active
        opacity 0.7
    .nextBtn-disable
        background-color: $keyboard-key-color
    .alpha-kb-flex1
        flex:1
    .alpha-kb-flex2
        flex:2
</style>